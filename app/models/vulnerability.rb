class Vulnerability < ActiveRecord::Base
  before_create 'self.status = Status.default'
  before_create :update_severity
  after_save :update_host_severity!

  belongs_to :host, :counter_cache => true
  belongs_to :plugin, :counter_cache => true
  belongs_to :status

  delegate :to_s, :to => :plugin

  def visible?
    if read_attribute(:visible).nil?
      plugin.visible?
    else
      read_attribute(:visible)
    end
  end

  acts_as_modifiable(:severity) do
    plugin.severity(host.location)
  end

  acts_as_mirrorable(:description) do
    plugin.description
  end

  acts_as_mirrorable(:evaluation) do
    plugin.evaluation
  end

  acts_as_mirrorable(:remediation) do
    plugin.remediation
  end

  def update_host_severity!
    host.update_severity!
  end
end
